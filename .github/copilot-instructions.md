# Copilot instructions for cuview

## Build, lint, and validation commands
- Install dependencies: `pnpm install`.
- Start dev server: `pnpm run dev`.
- Full repo check used here: `pnpm run check` (`pnpm run typecheck && biome check src/`).
- Lint only: `pnpm run lint` (auto-fix: `pnpm run lint:fix`).
- Build production assets: `pnpm run build` (`tsc -b && vite build`).
- Tests: `pnpm run test` (Vitest run mode).
- Single test command: `pnpm run test`.

## High-level architecture
- App bootstrap is in `src/main.tsx`: creates a shared TanStack Query client and TanStack Router instance, then renders both providers at the app root.
- Routing is file-based with TanStack Router under `src/routes`; the generated route map is `src/routeTree.gen.ts`.
- `src/routes/__root.tsx` composes global providers and shell concerns: `LayoutProvider` (theme/sidebar state), `CurioApiProvider` (API connection lifecycle), global `ErrorBoundary`, and `AppQuickSearch`.
- `src/routes/index.tsx` is an endpoint gate: it redirects to `/setup` until an endpoint is saved, then redirects to `/overview`.
- `src/routes/_app.tsx` provides the shared dashboard shell (`AppLayout`), while feature areas live in `src/routes/_app/**` (tasks, machines, sectors, market, config, etc.).
- Data access is centralized in `src/services/curio-api.ts`: JSON-RPC over WebSocket (prefixed as `CurioWeb.<method>`) plus REST over HTTP derived from the configured endpoint host.
- Query/mutation behavior is standardized in `src/hooks/use-curio-query.ts` (polling defaults, keying, invalidation), with domain-specific REST helpers in `src/services/*.ts` and payload/types in `src/types`.

## Key conventions in this repo
- Do not edit `src/routeTree.gen.ts` manually; it is regenerated by TanStack Router (`@tanstack/router-plugin` in `vite.config.ts`).
- New routes should follow TanStack file-route conventions (`createFileRoute(...)`) under `src/routes`.
- Tabbed sections use a recurring pattern:
  - `<feature>/index.tsx` defines the tab layout + `<Outlet />`
  - `<feature>/route.tsx` redirects `/feature` to a default child route
- Keep TanStack Query keys consistent with existing hooks:
  - RPC queries: `["curio", method, ...params]`
  - REST queries: `["curio-rest", path]`
  - Mutations invalidate those exact keys (see machine route mutations for examples).
- Use `usePageTitle(...)` in page-level routes to keep document titles consistent across route transitions.
- Endpoint and layout preferences are persisted in localStorage with existing keys:
  - `cuview-endpoint`, `cuview-theme`, `cuview-sidebar-collapsed`
- Use the `@/` import alias (mapped to `src` in `vite.config.ts`) instead of long relative paths.
- Styling uses Tailwind CSS v4 with HSL design tokens from `src/index.css` (`hsl(var(--...))`).
- Biome is the formatter/linter; current config excludes `src/routeTree.gen.ts` and `src/index.css`, and uses double quotes + semicolons + trailing commas.
